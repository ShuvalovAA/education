<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<!-- 1. Создать форму регистрации участников конференции: (10 баллов)

Имя (должны быть указаны полностью фамилия, имя и отчество), 
контактный телефон,
адрес электронной почты, 
список с секциями конференции (математика, физика, информатика)
дата рождения
доклад (переключатель), 
если есть доклад – то отображается поле для ввода темы. -->
<body>
    {% csrf_token %}
    <div id="divpersons"></div>
    <div id="form_reg_participant">
        <form name="feedback" onsubmit="false" >
            <div style="text-align: center; font-weight: bold;"> Форма регистрации участников конференции</div>
            <div>Имя</div>
            <input type="text" name="first_name" required="required">
            <div>Фамилия</div>
            <input type="text" name="last_name" required="required">
            <div>Отчество</div>
            <input type="text" name="middle_name" required="required">
            <div>Контактный телефон</div>
            <input type="text" name="phone" required="required">
            <div>Ваш email</div>
            <input type="email" name="email" required="required">
            <div>Дата рождения</div>
            <input type="date" name="birth_date">
            <div>Список с секциями конференции</div>
            <select name="theme" required="required">
                <option value="math">Математика</option>
                <option value="fiz">Физика</option>
                <option value="inf">информатика</option>
              </select>
            <div>Доклад? <input type="checkbox" name="report"></div>
            <div id="report_enter_info" style="display: none;">Введите тему доклада:
                <input type="text" name="report_theme"></div>
            <section>
            </section>
            <input type="submit" name="submit_btn" value="Отправить">
          </form>
    </div>
</body>
</html>

<script>
var checkbox = document.getElementsByName("report");
var div_report_enter_info = document.getElementById("report_enter_info");

checkbox[0].addEventListener('change', function() {
  if (this.checked) {
    div_report_enter_info.style.display="block";
  } else {
    div_report_enter_info.style.display="none";
  }
});


//2. Добавьте валидацию формы. (20 баллов)
//все поля, кроме даты рождения, обязательны для заполнения;
//поля имя, фамилия, отчество содержат только буквы русского алфавита;
///^[a-zA-Zа-яА-ЯЁё ]+$/
//поле телефон содержит только цифры, длина 11 символов, первые два символа +7
///^[\s()+-]*([0-9][\s()+-]*){6,20}$/
//корректность адреса электронной почты;
var isNotValid = function(s) {
    if (/[a-zA-Z ]/.test(s)){
        return true
    }else{
        return false
    };
};

var isNotValidPhone = function(s) {
    if (/^[\s()+-]*([0-9][\s()+-]*){6,20}$/.test(s)){
        return false
    }else{
        return true
    };
};

var isNotValidEmail = function(s) {
    if (/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(s)){
        return false
    }else{
        return true
    };
};
var birth_date = document.getElementsByName('birth_date')[0]
var first_name = document.getElementsByName('first_name')[0]
var last_name = document.getElementsByName('last_name')[0]
var middle_name = document.getElementsByName('middle_name')[0]
var full_name = [first_name, last_name, middle_name]

first_name.addEventListener('input', function() {
        if(isNotValid(this.value)){
            this.style.backgroundColor='#E9967A';
        }else{
            this.style.backgroundColor='white'
        };
    });

last_name.addEventListener('input', function() {
    if(isNotValid(this.value)){
            this.style.backgroundColor='#E9967A';
        }else{
            this.style.backgroundColor='white'
        };
    });

middle_name.addEventListener('input', function() {
    if(isNotValid(this.value)){
            this.style.backgroundColor='#E9967A';
        }else{
            this.style.backgroundColor='white'
        };
    });


var phone = document.getElementsByName('phone')[0]
phone.addEventListener('input', function() {
    
    if(isNotValidPhone(this.value)){
            this.style.backgroundColor='#E9967A';
        }else{
            this.style.backgroundColor='white';
        };
    });

var email = document.getElementsByName('email')[0]
email.addEventListener('input', function() {
    
    if(isNotValidEmail(this.value)){
            this.style.backgroundColor='#E9967A';
        }else{
            this.style.backgroundColor='white';
        };
    });



</script>
<!--3. Оформление формы регистрации. (20 баллов)-->
<style>
div {
    background-color: white;
    height: 5%;
    width: 50%;
}
input {
    background-color: white;
    height: 5%;
    width: 50%;
    border-radius: 10%;
    border-color: beige;
}

div#divpersons{
    margin-left: auto; 
    margin-right: 0;
    height: 5%;
    width: 50%;
 }

</style>

<!--4. После заполнения всех полей и нажатия на кнопку "отправить" формируется страница, содержащая все ответы пользователя.(20 баллов + 20 баллов за оформление)-->
<script>
var input_form_send = document.getElementsByName('submit_btn')[0]
var my_body = document.getElementsByTagName('body')[0]


input_form_send.addEventListener('click', function() {
    var is_exists = document.getElementById('data_for_send')
    var is_exists1 = document.getElementById('data_for_send1')

    if(is_exists){
        is_exists.remove();
    }

    if(is_exists1){
        is_exists1.remove();
    }

    var div1 = document.createElement('div');
    
    var div = document.createElement('div');
    div.setAttribute('id','data_for_send');
    div1.setAttribute('id','data_for_send1');
    div1.setAttribute ('style','background-color :green;');


    div1.innerHTML = 'Имя:' + first_name.value +'\n;Фамилия:' + last_name.value +"\n;Отчество:" + middle_name.value +"\n;Телефон:" + phone.value+"\n;email:" + email.value+"\n;День рождения:" + birth_date.value;
    document.getElementsByTagName('body')[0].appendChild(div1);
    div.innerHTML='Проверьте Ваши данные. Если всё хорошо нажмите <input type="button" name="submit_ok" value="ок">';
    document.getElementsByTagName('body')[0].appendChild(div);

    SaveDBprepare();

});

</script>
<!--5. Данные из формы сохранить в БД. (20 баллов)-->
<script>
    
    var SaveDBprepare = function(){
    var input_f_send = document.getElementsByName('submit_ok')[0]
    input_f_send.addEventListener('click', function() {
        ShowPerosnInfo();
        p_first_name = first_name.value
        p_last_name = last_name.value
        p_middle_name = middle_name.value
        p_birth_date = birth_date.value
        p_is_report = document.getElementsByName('report')[0].value
        p_report_theme = document.getElementsByName('report_theme')[0].value
        p_phone = phone.value
        p_email = email.value
        var csrftoken = csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        data = {
        "first_name": p_first_name,
        "last_name": p_last_name,
        "middle_name": p_middle_name,
        "birth_date": p_birth_date,
        "is_report": p_is_report,
        "report_theme": p_report_theme,
        "phone": p_phone,
        "email": p_email
        }
        data_send = JSON.stringify(data);

        
        var response = (fetch('http://127.0.0.1:8000/reg_per/save', {
            'method': 'POST',
            'headers': {
            'Content-Type': 'application/json; charset=utf-8',
            'X-CSRFToken': csrftoken
            },
            'body': data_send
        }));

        ShowPerosnInfo();

    });
    }


</script>

<!--6. Выведите список зарегистрированных участников в виде таблицы.(20 баллов + 20 баллов за оформление)-->
<script>
    var ShowPerosnInfo = function(){
        var csrftoken = csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", 'http://127.0.0.1:8000/reg_per/list', false);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', csrftoken);
        xhr.send();
        response = xhr.responseText
        response = JSON.parse(response)
        persons = JSON.parse(response['list'])
        var place_per = document.getElementById('divpersons')
        for(x=0;x<persons.length; x++){
            p = persons[x]
            var div = document.createElement('div');
            div.setAttribute('id','persons');
            div.setAttribute ('style','background-color :green;');
            div.innerHTML = p.pk + " " + p.fields.first_name + " " + p.fields.last_name + " " + p.fields.middle_name + " " + p.fields.birth_date + " " + p.fields.phone + " " + p.fields.email + " " + p.fields.report_theme
            place_per.appendChild(div)
        }

        // Выводим ответ сервера в консоли:

        console.log('Ответ сервера:');
        console.log(response);
    }


</script>


